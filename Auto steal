local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer
local StealEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Steal")
local STEAL_RANGE = 5

-- Animation names to block
local blockedAnims = {
    AnkleBreakerBack = true,
    AnkleBreakerLeft = true,
    AnkleBreakerRight = true,
}

-- Toggle state
local enabled = true

-- Toggle with R key
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.R then
        enabled = not enabled
        print("Auto Steal + Anti-Ankle Breaker: " .. (enabled and "ON" or "OFF"))
    end
end)

-- Main loop
RunService.RenderStepped:Connect(function()
    if not enabled then return end

    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") or not char:FindFirstChild("Humanoid") then return end

    local root = char.HumanoidRootPart
    local humanoid = char.Humanoid

    -- 🛡️ Anti-Ankle Breaker
    for _, anim in pairs(char:GetDescendants()) do
        if anim:IsA("Animation") and blockedAnims[anim.Name] then
            anim:Destroy()
        end
    end
    for _, track in pairs(humanoid:GetPlayingAnimationTracks()) do
        if blockedAnims[track.Name] then
            track:Stop()
        end
    end

    -- 🏀 Auto Steal
    for _, player in pairs(Players:GetPlayers()) do
        if player == LocalPlayer then continue end
        local enemyChar = player.Character
        if not enemyChar or not enemyChar:FindFirstChild("HumanoidRootPart") then continue end

        local dist = (root.Position - enemyChar.HumanoidRootPart.Position).Magnitude
        if dist > STEAL_RANGE then continue end

        local hasBall = enemyChar:FindFirstChild("Basketball") or enemyChar:FindFirstChildWhichIsA("Tool")
        if not hasBall then continue end

        local isDribbling =
            (enemyChar:FindFirstChild("WaitingDribble") and enemyChar.WaitingDribble.Value == true) or
            (enemyChar:FindFirstChild("DribbleChain") and enemyChar.DribbleChain.Value == true) or
            (enemyChar:FindFirstChild("DribbleMoving") and enemyChar.DribbleMoving.Value == true)

        if isDribbling then continue end

        -- ✅ Steal safely
        StealEvent:FireServer()
    end
end)
